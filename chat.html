<!-- chat.html -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Chatt</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      background: #003578;
      color: #ffc200;
      font-family: sans-serif;
      padding: 2rem;
    }
    .chat-list {
      max-height: 200px;
      overflow: hidden;
    }
    .chat-box {
      background: #004a99;
      padding: 1rem;
      margin-top: 1rem;
      height: 300px;
      overflow-y: auto;
      border-radius: 10px;
    }
    .message {
      margin: 0.5rem 0;
    }
    .input-area {
      display: flex;
      margin-top: 1rem;
    }
    .input-area input {
      flex: 1;
      padding: 0.5rem;
      border-radius: 8px;
      border: none;
    }
    .input-area button {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      background: #336bb8;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .username {
      font-weight: bold;
    }
    .heart {
      cursor: pointer;
      margin-left: 0.5rem;
      font-size: 1.2rem;
    }
    #loadMore {
      margin-top: 0.5rem;
      background: none;
      border: 1px solid #ffc200;
      padding: 0.5rem;
      color: #ffc200;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Chatt</h1>
  <div class="chat-list" id="userList"></div>
  <button id="loadMore">Visa fler</button>

  <div class="chat-box" id="chatBox"></div>

  <div class="input-area">
    <input id="messageInput" placeholder="Skriv meddelande..." />
    <button onclick="sendMessage()">Skicka</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://jtbcqgjkvzgcjobfbtad.supabase.co',
      'eyJhbGciOi...'
    );

    const userList = document.getElementById("userList");
    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("messageInput");
    const loadMoreBtn = document.getElementById("loadMore");

    let visibleCount = 3;
    let showingAllUsers = false;
    let allUsers = [];
    let selectedUserId = new URLSearchParams(window.location.search).get("uid");
    let currentUser;

    async function getCurrentUser() {
      const { data } = await supabase.auth.getUser();
      return data.user;
    }

    async function fetchUsers() {
      currentUser = await getCurrentUser();
      const { data: profiles } = await supabase
        .from("Profiles")
        .select("id, username")
        .neq("id", currentUser.id);

      const { data: favs } = await supabase
        .from("Favorites")
        .select("favorited_id")
        .eq("user_id", currentUser.id);

      const favorites = favs.map(f => f.favorited_id);

      allUsers = profiles.sort((a, b) => {
        const aFav = favorites.includes(a.id);
        const bFav = favorites.includes(b.id);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        return 0;
      });

      renderUserList();
    }

    function renderUserList() {
      userList.innerHTML = "";
      allUsers.slice(0, visibleCount).forEach(user => {
        const div = document.createElement("div");
        div.innerHTML = `
          <span class="username" style="cursor:pointer;" onclick="selectUser('${user.id}')">${user.username}</span>
          <span class="heart" onclick="toggleFavorite('${user.id}', this)">ü§ç</span>
        `;
        userList.appendChild(div);
      });
    }

    loadMoreBtn.onclick = () => {
      if (!showingAllUsers) {
        visibleCount = allUsers.length;
        loadMoreBtn.textContent = "Visa f√§rre";
        showingAllUsers = true;
      } else {
        visibleCount = 3;
        loadMoreBtn.textContent = "Visa fler";
        showingAllUsers = false;
      }
      renderUserList();
    };

    async function toggleFavorite(userId, el) {
      const { data } = await supabase
        .from("Favorites")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("favorited_id", userId);

      if (data.length > 0) {
        await supabase.from("Favorites").delete().match({ user_id: currentUser.id, favorited_id: userId });
        el.innerHTML = "ü§ç";
      } else {
        await supabase.from("Favorites").insert({ user_id: currentUser.id, favorited_id: userId });
        el.innerHTML = "‚ù§Ô∏è";
      }
      fetchUsers();
    }

    async function selectUser(id) {
      selectedUserId = id;
      chatBox.innerHTML = "";
      loadMessages();
    }

    async function loadMessages() {
      const { data, error } = await supabase
        .from("Messages")
        .select("*")
        .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
        .order("sent_at", { ascending: true });

      if (error) {
        console.error("Fel vid h√§mtning av meddelanden:", error.message);
        return;
      }

      chatBox.innerHTML = "";
      data.forEach(msg => {
        if ((msg.sender_id === currentUser.id && msg.receiver_id === selectedUserId) ||
            (msg.receiver_id === currentUser.id && msg.sender_id === selectedUserId)) {
          const p = document.createElement("p");
          p.className = "message";
          p.innerHTML = `<span class="username">${msg.sender_id === currentUser.id ? "Du" : "De"}:</span> ${msg.content} <br><small>${new Date(msg.sent_at).toLocaleString()}</small>`;
          chatBox.appendChild(p);
        }
      });

      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const content = input.value.trim();
      if (!content || !selectedUserId) return;

      const { error } = await supabase.from("Messages").insert({
        sender_id: currentUser.id,
        receiver_id: selectedUserId,
        content,
        read: false
      });

      if (error) {
        console.error("Fel vid s√§ndning av meddelande:", error.message);
        return;
      }

      input.value = "";
      loadMessages();
    }

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    fetchUsers().then(() => {
      if (selectedUserId) loadMessages();
    });
  </script>
</body>
</html>
