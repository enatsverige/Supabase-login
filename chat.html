<!-- chat.html -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Chatt</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      background: #001f3f;
      color: white;
      font-family: sans-serif;
      padding: 1rem;
    }
    #userList {
      margin-bottom: 1rem;
    }
    .username {
      font-weight: bold;
      margin-right: 1rem;
      cursor: pointer;
    }
    .heart {
      cursor: pointer;
      color: gray;
    }
    .heart.favorited {
      color: red;
    }
    #messages {
      margin-bottom: 1rem;
      background: #003366;
      padding: 1rem;
      border-radius: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    .message {
      margin-bottom: 0.5rem;
    }
    .sender {
      font-weight: bold;
      color: #ffc200;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #ffc200;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #003366;
      font-weight: bold;
    }
    input[type="text"] {
      padding: 0.5rem;
      width: 70%;
      border-radius: 8px;
      border: none;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>Chatt</h1>
  <div id="userList"></div>
  <button id="toggleUsers" onclick="toggleUserList()">Visa fler</button>

  <div id="messages"></div>

  <input type="text" id="messageInput" placeholder="Skriv ett meddelande..." />
  <button onclick="sendMessage()">Skicka</button>

  <script>
    const supabase = window.supabase.createClient(
      'https://jtbcqgjkvzgcjobfbtad.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YmNxZ2prdnpnY2pvYmZidGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzU0NTksImV4cCI6MjA2OTExMTQ1OX0.ogacm-3bmQI7WDgHZSI2r6jDOrDAGMfI7QtG0avYMTQ'
    );

    let currentUser;
    let selectedUser = null;
    let favorites = [];
    let users = [];
    let showAll = false;

    async function load() {
      const { data: auth } = await supabase.auth.getUser();
      currentUser = auth.user;

      const { data: favs } = await supabase
        .from('Favorites')
        .select('favorite_id')
        .eq('user_id', currentUser.id);
      favorites = favs.map(f => f.favorite_id);

      const { data: profiles } = await supabase
        .from('Profiles')
        .select('id, username');

      users = profiles.filter(u => u.id !== currentUser.id);
      users.sort((a, b) => {
        const aFav = favorites.includes(a.id);
        const bFav = favorites.includes(b.id);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        return a.username.localeCompare(b.username);
      });

      renderUserList();
    }

    function renderUserList() {
      const list = document.getElementById("userList");
      list.innerHTML = "";

      const visibleUsers = showAll ? users : users.slice(0, 3);
      visibleUsers.forEach(user => {
        const div = document.createElement("div");
        const isFav = favorites.includes(user.id);
        div.innerHTML = `
          <span class="username" onclick="selectUser('${user.id}')">${user.username}</span>
          <span class="heart ${isFav ? 'favorited' : ''}" onclick="toggleFavorite('${user.id}', this)">♥</span>
        `;
        list.appendChild(div);
      });

      const toggleBtn = document.getElementById('toggleUsers');
      toggleBtn.textContent = showAll ? 'Visa färre' : 'Visa fler';
    }

    function toggleUserList() {
      showAll = !showAll;
      renderUserList();
    }

    async function toggleFavorite(userId, el) {
      if (el.classList.contains('favorited')) {
        await supabase
          .from('Favorites')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('favorite_id', userId);
        el.classList.remove('favorited');
      } else {
        await supabase
          .from('Favorites')
          .insert({ user_id: currentUser.id, favorite_id: userId });
        el.classList.add('favorited');
      }
      await load();
    }

    async function selectUser(userId) {
      selectedUser = userId;
      document.getElementById("messages").innerHTML = "";

      const { data: messages } = await supabase
        .from('Messages')
        .select('sender_id, receiver_id, content, created_at')
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`)
        .order('created_at', { ascending: true });

      messages.forEach(msg => {
        const div = document.createElement("div");
        div.className = "message";
        const sender = msg.sender_id === currentUser.id ? "Du" : "Den andra";
        div.innerHTML = `<span class="sender">${sender}:</span> ${msg.content}`;
        document.getElementById("messages").appendChild(div);
      });

      const messagesDiv = document.getElementById("messages");
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const content = input.value.trim();
      if (!content || !selectedUser) return;

      await supabase.from('Messages').insert({
        sender_id: currentUser.id,
        receiver_id: selectedUser,
        content
      });

      input.value = "";
      selectUser(selectedUser);
    }

    load();
  </script>
</body>
</html>
