<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Användare</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #002855;
      color: #ffc200;
      padding: 2rem;
      text-align: center;
    }

    h1 {
      margin-bottom: 1rem;
    }

    #search {
      padding: 0.5rem;
      width: 300px;
      max-width: 80%;
      margin-bottom: 1rem;
      border-radius: 5px;
      border: none;
      font-size: 1rem;
    }

    .user {
      background: #003e87;
      margin: 0.5rem auto;
      padding: 1rem;
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
    }

    .user a {
      color: #ffc200;
      text-decoration: none;
      font-size: 1.2rem;
    }

    .heart {
      cursor: pointer;
      font-size: 1.5rem;
    }

    .heart.favorited {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Alla användare</h1>
  <input type="text" id="search" placeholder="Sök användarnamn...">
  <div id="user-list"></div>

  <script>
    const supabase = window.supabase.createClient(
      'https://jtbcqgjkvzgcjobfbtad.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YmNxZ2prdnpnY2pvYmZidGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzU0NTksImV4cCI6MjA2OTExMTQ1OX0.ogacm-3bmQI7WDgHZSI2r6jDOrDAGMfI7QtG0avYMTQ'
    );

    let currentUserId;
    let favorites = [];

    async function loadCurrentUser() {
      const { data: authData } = await supabase.auth.getUser();
      currentUserId = authData.user.id;
    }

    async function loadFavorites() {
      const { data, error } = await supabase
        .from("Favorites")
        .select("favorited_id")
        .eq("user_id", currentUserId);

      if (!error && data) {
        favorites = data.map(f => f.favorited_id);
      }
    }

    async function toggleFavorite(userId) {
      const isFav = favorites.includes(userId);
      if (isFav) {
        await supabase
          .from("Favorites")
          .delete()
          .match({ user_id: currentUserId, favorited_id: userId });
        favorites = favorites.filter(id => id !== userId);
      } else {
        await supabase
          .from("Favorites")
          .insert([{ user_id: currentUserId, favorited_id: userId }]);
        favorites.push(userId);
      }
      loadUsers();
    }

    async function loadUsers() {
      const searchTerm = document.getElementById("search").value.toLowerCase();

      const { data: users, error } = await supabase
        .from("Profiles")
        .select("id, username")
        .neq("id", currentUserId);

      if (error) {
        console.error("Fel vid hämtning av användare:", error.message);
        return;
      }

      const userList = document.getElementById("user-list");
      userList.innerHTML = "";

      const filtered = users.filter(u => u.username.toLowerCase().includes(searchTerm));
      const sorted = filtered.sort((a, b) => {
        const afav = favorites.includes(a.id);
        const bfav = favorites.includes(b.id);
        return (bfav - afav);
      });

      sorted.forEach(user => {
        const userDiv = document.createElement("div");
        userDiv.className = "user";

        const link = document.createElement("a");
        link.href = `chat.html?to=${user.id}`;
        link.textContent = user.username;

        const heart = document.createElement("span");
        heart.className = "heart" + (favorites.includes(user.id) ? " favorited" : "");
        heart.innerHTML = "❤️";
        heart.onclick = () => toggleFavorite(user.id);

        userDiv.appendChild(link);
        userDiv.appendChild(heart);
        userList.appendChild(userDiv);
      });
    }

    document.getElementById("search").addEventListener("input", loadUsers);

    async function init() {
      await loadCurrentUser();
      await loadFavorites();
      await loadUsers();
    }

    init();
  </script>
</body>
</html>
