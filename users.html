<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alla Användare</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #003578;
      color: #ffc200;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
    }
    ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ffc200;
      border-radius: 8px;
      background: #004a99;
    }
    li {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #ffc200;
      align-items: center;
    }
    li:hover {
      background-color: #003466;
    }
    .heart {
      cursor: pointer;
      font-size: 1.2rem;
      margin-left: 5px;
      color: grey;
      user-select: none;
    }
    .heart.favorited {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Alla Användare</h1>
  <input type="text" id="search" placeholder="Sök användarnamn..." />
  <ul id="user-list"></ul>

  <script>
    const supabase = window.supabase.createClient(
      'https://jtbcqgjkvzgcjobfbtad.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YmNxZ2prdnpnY2pvYmZidGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzU0NTksImV4cCI6MjA2OTExMTQ1OX0.ogacm-3bmQI7WDgHZSI2r6jDOrDAGMfI7QtG0avYMTQ'
    );

    let users = [];
    let favorites = [];

    // Hämta sparade favoriter från localStorage
    function loadFavorites() {
      const fav = localStorage.getItem('favorites');
      favorites = fav ? JSON.parse(fav) : [];
    }

    function saveFavorites() {
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    async function fetchUsers() {
      const { data, error } = await supabase.from('"Profiles"').select('id, username');
      if (error) {
        alert('Fel vid hämtning av användare: ' + error.message);
        return;
      }
      users = data.filter(u => u.username); // Filtrera bort utan username
      sortAndRenderUsers();
    }

    function sortAndRenderUsers() {
      // Sortera så favoriter kommer först
      users.sort((a,b) => {
        const aFav = favorites.includes(a.id);
        const bFav = favorites.includes(b.id);
        if (aFav && !bFav) return -1;
        if (!aFav && bFav) return 1;
        return a.username.localeCompare(b.username);
      });
      renderUsers(users);
    }

    function renderUsers(list) {
      const ul = document.getElementById('user-list');
      ul.innerHTML = '';
      list.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.username;
        li.setAttribute('data-id', user.id);

        const heart = document.createElement('span');
        heart.textContent = '♥';
        heart.classList.add('heart');
        if (favorites.includes(user.id)) {
          heart.classList.add('favorited');
        }
        heart.addEventListener('click', e => {
          e.stopPropagation();
          toggleFavorite(user.id, heart);
        });

        li.appendChild(heart);

        // Klicka på användarnamn för att öppna chatten med den användaren
        li.addEventListener('click', () => {
          window.location.href = `chat.html?to=${user.id}`;
        });

        ul.appendChild(li);
      });
    }

    function toggleFavorite(userId, heartEl) {
      if (favorites.includes(userId)) {
        favorites = favorites.filter(f => f !== userId);
        heartEl.classList.remove('favorited');
      } else {
        favorites.push(userId);
        heartEl.classList.add('favorited');
      }
      saveFavorites();
      sortAndRenderUsers();
    }

    document.getElementById('search').addEventListener('input', e => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = users.filter(u => u.username.toLowerCase().includes(searchTerm));
      renderUsers(filtered);
    });

    loadFavorites();
    fetchUsers();
  </script>
</body>
</html>
