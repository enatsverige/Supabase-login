<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyheter</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #003578;
            color: #ffc200;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .post-form, .post, .comment {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        input, textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #ffffff;
            color: #000000;
            border: none;
            border-radius: 3px;
        }
        button {
            background-color: #ffc200;
            color: #003578;
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #e6a800;
        }
        .post-actions, .comment-actions {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .loading {
            font-style: italic;
            color: #ffffff;
        }
        .no-posts {
            font-style: italic;
            color: #ffffff;
        }
        .file-preview {
            margin-top: 10px;
            max-width: 200px;
        }
        .file-preview img, .file-preview video {
            max-width: 100%;
            border-radius: 5px;
        }
        .like-button.active {
            background-color: #28a745;
            color: #ffffff;
        }
        .dislike-button.active {
            background-color: #dc3545;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nyheter</h1>
        <div id="auth-status"></div>
        
        <!-- Kodkontroll för att visa postformulär -->
        <div id="code-check">
            <input type="text" id="secret-code" placeholder="Ange kod för att lägga upp">
            <button onclick="checkCode()">Verifiera kod</button>
        </div>
        
        <!-- Formulär för att skapa inlägg -->
        <div id="post-form" class="post-form hidden">
            <input type="text" id="post-title" placeholder="Titel">
            <textarea id="post-content" placeholder="Innehåll"></textarea>
            <input type="file" id="post-media" accept="image/*,video/*" capture="environment">
            <div id="media-preview" class="file-preview"></div>
            <button onclick="clearPreview()">Rensa förhandsvisning</button>
            <button onclick="createPost()">Publicera</button>
        </div>

        <!-- Sökfält -->
        <input type="text" id="search-input" placeholder="Sök efter inlägg..." oninput="searchPosts()">
        
        <!-- Inläggslista -->
        <div id="posts-container"></div>
        <button id="toggle-posts" onclick="togglePosts()">Visa alla</button>
    </div>

    <script>
        // Supabase-konfiguration
        const supabaseUrl = 'https://jtbcqgjkvzgcjobfbtad.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YmNxZ2prdnpnY2pvYmZidGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzU0NTksImV4cCI6MjA2OTExMTQ1OX0.ogacm-3bmQI7WDgHZSI2r6jDOrDAGMfI7QtG0avYMTQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        const SECRET_CODE = 'HHGffajkskksm13324..1!?';
        let allPosts = [];
        let displayedPosts = [];
        let showAll = false;

        // Kontrollera inloggning
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            const authStatus = document.getElementById('auth-status');
            if (error || !user) {
                authStatus.innerHTML = 'Du måste vara inloggad. <a href="index.html">Logga in</a>';
                console.error('Fel vid autentisering:', error);
                return false;
            }
            authStatus.innerHTML = `Inloggad som: ${user.email}`;
            return user;
        }

        // Verifiera hemlig kod
        function checkCode() {
            const codeInput = document.getElementById('secret-code').value;
            const postForm = document.getElementById('post-form');
            if (codeInput === SECRET_CODE) {
                postForm.classList.remove('hidden');
                document.getElementById('code-check').classList.add('hidden');
            } else {
                alert('Felaktig kod!');
            }
        }

        // Rensa förhandsvisning
        function clearPreview() {
            const fileInput = document.getElementById('post-media');
            const preview = document.getElementById('media-preview');
            fileInput.value = '';
            preview.innerHTML = '';
        }

        // Förhandsvisning av fil
        document.getElementById('post-media').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const preview = document.getElementById('media-preview');
            preview.innerHTML = '';

            if (!file) return;

            // Validera filstorlek (max 10 MB)
            const maxSize = 10 * 1024 * 1024; // 10 MB i bytes
            if (file.size > maxSize) {
                alert('Filen är för stor! Max 10 MB.');
                event.target.value = '';
                return;
            }

            // Validera filtyp
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'video/mp4', 'video/webm'];
            if (!allowedTypes.includes(file.type)) {
                alert('Endast bilder (JPEG, PNG, WebP) och videor (MP4, WebM) är tillåtna.');
                event.target.value = '';
                return;
            }

            // Skapa förhandsvisning
            const url = URL.createObjectURL(file);
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = url;
                preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                preview.appendChild(video);
            }
        });

        // Skapa nytt inlägg
        async function createPost() {
            const user = await checkAuth();
            if (!user) return;

            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const fileInput = document.getElementById('post-media');
            const file = fileInput.files[0];
            let mediaUrl = '';

            if (!title || !content) {
                alert('Titel och innehåll krävs!');
                return;
            }

            try {
                document.getElementById('post-form').classList.add('loading');
                document.getElementById('post-form').innerHTML += '<p class="loading">Laddar upp...</p>';

                // Hoppa över listBuckets() eftersom det är opålitligt, anta att post-media finns
console.log('Skipping bucket list check, assuming post-media exists based on manual upload success');

                // Ladda upp fil till Supabase Storage om en fil valts
                if (file) {
                    const fileName = `${user.id}/${Date.now()}_${file.name}`;
                    console.log('Försöker ladda upp fil:', fileName, 'Typ:', file.type, 'Storlek:', file.size);

                    // Sätt en timeout för uppladdning (30 sekunder)
                    const uploadPromise = supabase.storage
                        .from('post-media')
                        .upload(fileName, file);
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Uppladdningen tog för lång tid')), 30000);
                    });

                    const { data, error: uploadError } = await Promise.race([uploadPromise, timeoutPromise]);

                    if (uploadError) {
                        console.error('Fel vid filuppladdning:', uploadError);
                        alert(`Kunde inte ladda upp filen: ${uploadError.message}. Kontrollera att bucketen post-media är publik och att RLS-policyerna är korrekta.`);
                        return;
                    }

                    // Hämta publik URL för filen
                    const { data: urlData } = supabase.storage
                        .from('post-media')
                        .getPublicUrl(fileName);
                    mediaUrl = urlData.publicUrl;
                    console.log('Uppladdad fil-URL:', mediaUrl);

                    // Verifiera att URL:en är giltig
                    try {
                        const response = await fetch(mediaUrl, { method: 'HEAD' });
                        if (!response.ok) {
                            console.error('Ogiltig media-URL:', mediaUrl, 'Status:', response.status);
                            alert('Filen laddades upp, men URL:en är inte tillgänglig. Kontrollera att bucketen är publik.');
                            return;
                        }
                    } catch (urlError) {
                        console.error('Fel vid verifiering av media-URL:', urlError);
                        alert('Filen laddades upp, men URL:en kunde inte verifieras.');
                        return;
                    }
                }

                // Spara inlägget
                const { error } = await supabase
                    .from('posts')
                    .insert([{ title, content, media_url: mediaUrl, user_id: user.id }]);

                if (error) {
                    console.error('Fel vid publicering:', error);
                    alert('Kunde inte publicera inlägget: ' + error.message);
                    return;
                }

                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                fileInput.value = '';
                document.getElementById('media-preview').innerHTML = '';
                fetchPosts();
            } catch (err) {
                console.error('Oväntat fel vid publicering:', err);
                alert('Ett oväntat fel uppstod: ' + err.message);
            } finally {
                document.getElementById('post-form').classList.remove('loading');
                document.querySelector('.loading')?.remove();
            }
        }

        // Hämta och visa inlägg
        async function fetchPosts(searchQuery = '') {
            try {
                document.getElementById('posts-container').innerHTML = '<p class="loading">Laddar inlägg...</p>';

                // Hämta posts och post_likes
                const { data: posts, error: postsError } = await supabase
                    .from('posts')
                    .select(`
                        id, title, content, media_url, user_id, created_at,
                        post_likes!post_likes_post_id_fkey(is_liked, user_id)
                    `)
                    .order('created_at', { ascending: false })
                    .ilike('title', `%${searchQuery}%`);

                if (postsError) {
                    console.error('Fel vid hämtning av inlägg:', postsError);
                    alert('Kunde inte hämta inlägg: ' + postsError.message);
                    return;
                }

                console.log('Hämtade posts:', posts);

                // Hämta comments separat
                const postIds = posts.map(post => post.id);
                const { data: comments, error: commentsError } = await supabase
                    .from('comments')
                    .select(`
                        id, post_id, user_id, text, created_at,
                        comment_likes!comment_likes_comment_id_fkey(is_liked, user_id)
                    `)
                    .in('post_id', postIds);

                if (commentsError) {
                    console.error('Fel vid hämtning av kommentarer:', commentsError);
                    // Fortsätt även om kommentarer saknas
                }

                console.log('Hämtade comments:', comments || []);

                // Hämta usernames från Profiles
                const userIds = [
                    ...new Set([
                        ...posts.map(post => post.user_id),
                        ...(comments || []).map(comment => comment.user_id)
                    ])
                ];

                let profiles = [];
                if (userIds.length > 0) {
                    const { data: profilesData, error: profilesError } = await supabase
                        .from('Profiles')
                        .select('id, username')
                        .in('id', userIds);

                    if (profilesError) {
                        console.error('Fel vid hämtning av profiler:', profilesError);
                        alert('Kunde inte hämta profiler: ' + profilesError.message);
                        return;
                    }
                    profiles = profilesData;
                }

                console.log('Hämtade profiles:', profiles);

                // Skapa username-map
                const usernameMap = profiles.reduce((map, profile) => {
                    map[profile.id] = profile.username;
                    return map;
                }, {});

                // Hämta aktuell användare för att markera egna likes
                const { data: { user } } = await supabase.auth.getUser();

                // Kombinera data
                allPosts = posts.map(post => ({
                    ...post,
                    username: usernameMap[post.user_id] || 'Okänd användare',
                    userHasLiked: post.post_likes?.some(like => like.user_id === user?.id && like.is_liked),
                    userHasDisliked: post.post_likes?.some(like => like.user_id === user?.id && !like.is_liked),
                    comments: (comments || [])
                        .filter(comment => comment.post_id === post.id)
                        .map(comment => ({
                            ...comment,
                            username: usernameMap[comment.user_id] || 'Okänd användare',
                            userHasLiked: comment.comment_likes?.some(like => like.user_id === user?.id && like.is_liked),
                            userHasDisliked: comment.comment_likes?.some(like => like.user_id === user?.id && !like.is_liked)
                        }))
                }));

                console.log('Kombinerade allPosts:', allPosts);
                updatePostsDisplay();
            } catch (err) {
                console.error('Oväntat fel vid hämtning av inlägg:', err);
                alert('Ett oväntat fel uppstod vid hämtning av inlägg: ' + err.message);
            } finally {
                document.querySelector('.loading')?.remove();
            }
        }

        // Uppdatera visning av inlägg
        function updatePostsDisplay() {
            const postsContainer = document.getElementById('posts-container');
            const toggleButton = document.getElementById('toggle-posts');
            displayedPosts = showAll ? allPosts : allPosts.slice(0, 5);
            
            if (displayedPosts.length === 0) {
                postsContainer.innerHTML = '<p class="no-posts">Inga inlägg hittades.</p>';
                toggleButton.classList.add('hidden');
                return;
            }

            postsContainer.innerHTML = displayedPosts.map(post => {
                const likes = post.post_likes ? post.post_likes.filter(like => like.is_liked).length : 0;
                const dislikes = post.post_likes ? post.post_likes.length - likes : 0;
                const topComments = post.comments
                    ? post.comments
                        .map(comment => ({
                            ...comment,
                            likes: comment.comment_likes ? comment.comment_likes.filter(like => like.is_liked).length : 0,
                            dislikes: comment.comment_likes ? comment.comment_likes.length - comment.comment_likes.filter(like => like.is_liked).length : 0
                        }))
                        .sort((a, b) => b.likes - a.likes)
                        .slice(0, 3)
                    : [];

                return `
                    <div class="post">
                        <h2>${post.title}</h2>
                        <p>${post.content}</p>
                        ${post.media_url ? (post.media_url.includes('.mp4') || post.media_url.includes('.webm') ? 
                            `<video src="${post.media_url}" controls style="max-width: 100%;"></video>` : 
                            `<img src="${post.media_url}" alt="Media" style="max-width: 100%;">`) : ''}
                        <p>Upplagt av: ${post.username} | ${new Date(post.created_at).toLocaleString()}</p>
                        <div class="post-actions">
                            <button class="like-button ${post.userHasLiked ? 'active' : ''}" onclick="likePost('${post.id}', true)">Gilla (${likes})</button>
                            <button class="dislike-button ${post.userHasDisliked ? 'active' : ''}" onclick="likePost('${post.id}', false)">Ogilla (${dislikes})</button>
                        </div>
                        <div class="comments">
                            <h3>Kommentarer</h3>
                            ${topComments.map(comment => `
                                <div class="comment">
                                    <p>${comment.text}</p>
                                    <p>Av: ${comment.username} | ${new Date(comment.created_at).toLocaleString()}</p>
                                    <div class="comment-actions">
                                        <button class="like-button ${comment.userHasLiked ? 'active' : ''}" onclick="likeComment('${comment.id}', true)">Gilla (${comment.likes})</button>
                                        <button class="dislike-button ${comment.userHasDisliked ? 'active' : ''}" onclick="likeComment('${comment.id}', false)">Ogilla (${comment.dislikes})</button>
                                    </div>
                                </div>
                            `).join('')}
                            <button onclick="toggleComments('${post.id}')">${post.comments && post.comments.length > 3 ? 'Visa fler' : ''}</button>
                            <div id="all-comments-${post.id}" class="hidden">
                                ${post.comments ? post.comments.map(comment => `
                                    <div class="comment">
                                        <p>${comment.text}</p>
                                        <p>Av: ${comment.username} | ${new Date(comment.created_at).toLocaleString()}</p>
                                        <div class="comment-actions">
                                            <button class="like-button ${comment.userHasLiked ? 'active' : ''}" onclick="likeComment('${comment.id}', true)">Gilla (${comment.comment_likes ? comment.comment_likes.filter(like => like.is_liked).length : 0})</button>
                                            <button class="dislike-button ${comment.userHasDisliked ? 'active' : ''}" onclick="likeComment('${comment.id}', false)">Ogilla (${comment.comment_likes ? comment.comment_likes.length - comment.comment_likes.filter(like => like.is_liked).length : 0})</button>
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <textarea id="comment-content-${post.id}" placeholder="Skriv en kommentar"></textarea>
                            <button onclick="addComment('${post.id}')">Kommentera</button>
                        </div>
                    </div>
                `;
            }).join('');

            toggleButton.textContent = showAll ? 'Visa färre' : 'Visa alla';
            toggleButton.classList.toggle('hidden', allPosts.length <= 5);
        }

        // Växla mellan visa alla/färre inlägg
        function togglePosts() {
            showAll = !showAll;
            updatePostsDisplay();
        }

        // Växla kommentarer
        function toggleComments(postId) {
            const allCommentsDiv = document.getElementById(`all-comments-${postId}`);
            const toggleButton = allCommentsDiv.previousElementSibling;
            allCommentsDiv.classList.toggle('hidden');
            toggleButton.textContent = allCommentsDiv.classList.contains('hidden') ? 'Visa fler' : 'Visa färre';
        }

        // Gilla/ogilla inlägg
        async function likePost(postId, isLiked) {
            const user = await checkAuth();
            if (!user) return;

            try {
                console.log('Försöker hämta post_likes för post_id:', postId, 'och user_id:', user.id);
                const { data: existingLikes, error: selectError } = await supabase
                    .from('post_likes')
                    .select('*')
                    .eq('post_id', postId)
                    .eq('user_id', user.id);

                if (selectError) {
                    console.error('Fel vid hämtning av post_likes:', selectError);
                    alert('Kunde inte hämta gillningar: ' + selectError.message);
                    return;
                }

                console.log('Hämtade existingLikes:', existingLikes);

                if (existingLikes && existingLikes.length > 0) {
                    if (existingLikes[0].is_liked === isLiked) {
                        // Ta bort like om samma val görs igen
                        const { error: deleteError } = await supabase
                            .from('post_likes')
                            .delete()
                            .eq('post_id', postId)
                            .eq('user_id', user.id);

                        if (deleteError) {
                            console.error('Fel vid borttagning av post_likes:', deleteError);
                            alert('Kunde inte ta bort gillningen: ' + deleteError.message);
                            return;
                        }
                    } else {
                        // Uppdatera befintlig like
                        const { error: updateError } = await supabase
                            .from('post_likes')
                            .update({ is_liked: isLiked })
                            .eq('post_id', postId)
                            .eq('user_id', user.id);

                        if (updateError) {
                            console.error('Fel vid uppdatering av post_likes:', updateError);
                            alert('Kunde inte uppdatera gillningen: ' + updateError.message);
                            return;
                        }
                    }
                } else {
                    // Skapa ny like
                    const { error: insertError } = await supabase
                        .from('post_likes')
                        .insert([{ post_id: postId, user_id: user.id, is_liked: isLiked }]);

                    if (insertError) {
                        console.error('Fel vid insättning av post_likes:', insertError);
                        alert('Kunde inte lägga till gillningen: ' + insertError.message);
                        return;
                    }
                }

                fetchPosts();
            } catch (err) {
                console.error('Oväntat fel vid gilla/ogilla inlägg:', err);
                alert('Ett oväntat fel uppstod: ' + err.message);
            }
        }

        // Lägg till kommentar
        async function addComment(postId) {
            const user = await checkAuth();
            if (!user) return;

            const content = document.getElementById(`comment-content-${postId}`).value;
            if (!content) {
                alert('Kommentaren kan inte vara tom!');
                return;
            }

            try {
                await supabase
                    .from('comments')
                    .insert([{ post_id: postId, user_id: user.id, text: content }]);

                document.getElementById(`comment-content-${postId}`).value = '';
                fetchPosts();
            } catch (err) {
                console.error('Fel vid kommentering:', err);
                alert('Kunde inte lägga till kommentaren: ' + err.message);
            }
        }

        // Gilla/ogilla kommentar
        async function likeComment(commentId, isLiked) {
            const user = await checkAuth();
            if (!user) return;

            try {
                console.log('Försöker hämta comment_likes för comment_id:', commentId, 'och user_id:', user.id);
                const { data: existingLikes, error: selectError } = await supabase
                    .from('comment_likes')
                    .select('*')
                    .eq('comment_id', commentId)
                    .eq('user_id', user.id);

                if (selectError) {
                    console.error('Fel vid hämtning av comment_likes:', selectError);
                    alert('Kunde inte hämta gillningar: ' + selectError.message);
                    return;
                }

                console.log('Hämtade existingLikes:', existingLikes);

                if (existingLikes && existingLikes.length > 0) {
                    if (existingLikes[0].is_liked === isLiked) {
                        // Ta bort like om samma val görs igen
                        const { error: deleteError } = await supabase
                            .from('comment_likes')
                            .delete()
                            .eq('comment_id', commentId)
                            .eq('user_id', user.id);

                        if (deleteError) {
                            console.error('Fel vid borttagning av comment_likes:', deleteError);
                            alert('Kunde inte ta bort gillningen: ' + deleteError.message);
                            return;
                        }
                    } else {
                        // Uppdatera befintlig like
                        const { error: updateError } = await supabase
                            .from('comment_likes')
                            .update({ is_liked: isLiked })
                            .eq('comment_id', commentId)
                            .eq('user_id', user.id);

                        if (updateError) {
                            console.error('Fel vid uppdatering av comment_likes:', updateError);
                            alert('Kunde inte uppdatera gillningen: ' + updateError.message);
                            return;
                        }
                    }
                } else {
                    // Skapa ny like
                    const { error: insertError } = await supabase
                        .from('comment_likes')
                        .insert([{ comment_id: commentId, user_id: user.id, is_liked: isLiked }]);

                    if (insertError) {
                        console.error('Fel vid insättning av comment_likes:', insertError);
                        alert('Kunde inte lägga till gillningen: ' + insertError.message);
                        return;
                    }
                }

                fetchPosts();
            } catch (err) {
                console.error('Fel vid gilla/ogilla kommentar:', err);
                alert('Ett oväntat fel uppstod: ' + err.message);
            }
        }

        // Sök inlägg
        function searchPosts() {
            const searchQuery = document.getElementById('search-input').value;
            fetchPosts(searchQuery);
        }

        // Initial laddning
        checkAuth().then(user => {
            if (user) fetchPosts();
        });
    </script>
</body>
</html>
