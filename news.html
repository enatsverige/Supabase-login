<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Nyheter & Viktig info</title>
  <style>
    body {
      background-color: #0d47a1;
      font-family: Arial, sans-serif;
      color: white;
      margin: 20px;
    }
    .post {
      background-color: #1565c0;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    .post-header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .buttons, .comments {
      margin-top: 10px;
    }
    button {
      margin-right: 10px;
      background-color: #1e88e5;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    #logout {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f44336;
    }
    .comment {
      background-color: #1976d2;
      margin-top: 5px;
      padding: 5px;
      border-radius: 5px;
    }
    .comment-header {
      font-size: 0.85em;
      color: #bbb;
    }
    #toggle-all {
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>Nyheter & Viktig info</h1>
<div id="posts"></div>
<button id="toggle-all">Visa alla</button>
<button id="logout">Logga ut</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient('https://jtbcqgjkvzgcjobfbtad.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YmNxZ2prdnpnY2pvYmZidGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzU0NTksImV4cCI6MjA2OTExMTQ1OX0.ogacm-3bmQI7WDgHZSI2r6jDOrDAGMfI7QtG0avYMTQ');
let showingAll = false;

async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    alert('Du m√•ste vara inloggad.');
    window.location.href = 'index.html';
  } else {
    loadPosts();
  }
}

async function loadPosts() {
  const limit = showingAll ? 100 : 5;
  const { data: posts } = await supabase
    .from('posts')
    .select('id, title, content, media_url, user_id, created_at, Profiles(username)')
    .order('created_at', { ascending: false })
    .limit(limit);

  const postsContainer = document.getElementById('posts');
  postsContainer.innerHTML = '';

  for (const post of posts) {
    const postDiv = document.createElement('div');
    postDiv.classList.add('post');

    const date = new Date(post.created_at).toLocaleString();
    postDiv.innerHTML = `
      <div class="post-header">${post.title} - <i>${post.Profiles?.username || 'Ok√§nd'}</i> - <small>${date}</small></div>
      <div>${post.content || ''}</div>
      ${post.media_url ? `<img src="${post.media_url}" style="max-width: 100%; margin-top: 10px; border-radius: 5px;" />` : ''}
      <div class="buttons">
        <button onclick="toggleLike(${post.id}, true)">üëç</button>
        <span id="like-count-${post.id}">0</span>
        <button onclick="toggleLike(${post.id}, false)">üëé</button>
        <span id="dislike-count-${post.id}">0</span>
      </div>
      <div class="comments" id="comments-${post.id}"></div>
      <input type="text" placeholder="Kommentera..." id="comment-input-${post.id}" />
      <button onclick="submitComment(${post.id})">Skicka</button>
    `;
    postsContainer.appendChild(postDiv);
    await loadLikes(post.id);
    await loadComments(post.id);
  }
}

async function loadLikes(postId) {
  const { data } = await supabase
    .from('post_likes')
    .select('is_liked')
    .eq('post_id', postId);

  const likes = data.filter(l => l.is_liked).length;
  const dislikes = data.filter(l => !l.is_liked).length;

  document.getElementById(`like-count-${postId}`).textContent = likes;
  document.getElementById(`dislike-count-${postId}`).textContent = dislikes;
}

async function toggleLike(postId, isLike) {
  const { data: { session } } = await supabase.auth.getSession();
  const userId = session.user.id;
  const { data: existing } = await supabase
    .from('post_likes')
    .select('*')
    .eq('post_id', postId)
    .eq('user_id', userId)
    .maybeSingle();

  if (existing) {
    if (existing.is_liked === isLike) {
      await supabase.from('post_likes').delete().eq('post_id', postId).eq('user_id', userId);
    } else {
      await supabase.from('post_likes').update({ is_liked: isLike }).eq('post_id', postId).eq('user_id', userId);
    }
  } else {
    await supabase.from('post_likes').insert({ post_id: postId, user_id: userId, is_liked: isLike });
  }
  await loadLikes(postId);
}

async function loadComments(postId) {
  const { data: comments } = await supabase
    .from('comments')
    .select('id, content, created_at, user_id, Profiles(username), comment_likes(user_id)')
    .eq('post_id', postId);

  const commentContainer = document.getElementById(`comments-${postId}`);
  commentContainer.innerHTML = '';

  const sorted = comments.sort((a, b) => b.comment_likes.length - a.comment_likes.length);
  const topThree = sorted.slice(0, 3);

  for (const comment of topThree) {
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerHTML = `
      <div class="comment-header">${comment.Profiles?.username || 'Ok√§nd'} - ${new Date(comment.created_at).toLocaleString()}</div>
      ${comment.content}
      <div>
        <button onclick="toggleCommentLike(${comment.id})">‚ù§Ô∏è</button>
        <span>${comment.comment_likes.length}</span>
      </div>
    `;
    commentContainer.appendChild(div);
  }
}

async function toggleCommentLike(commentId) {
  const { data: { session } } = await supabase.auth.getSession();
  const userId = session.user.id;
  const { data: existing } = await supabase
    .from('comment_likes')
    .select('*')
    .eq('comment_id', commentId)
    .eq('user_id', userId)
    .maybeSingle();

  if (existing) {
    await supabase.from('comment_likes').delete().eq('comment_id', commentId).eq('user_id', userId);
  } else {
    await supabase.from('comment_likes').insert({ comment_id: commentId, user_id: userId });
  }
  loadPosts();
}

async function submitComment(postId) {
  const input = document.getElementById(`comment-input-${postId}`);
  const content = input.value.trim();
  if (!content) return;

  const { data: { session } } = await supabase.auth.getSession();
  const userId = session.user.id;

  await supabase.from('comments').insert({ post_id: postId, user_id: userId, content });
  input.value = '';
  await loadComments(postId);
}

document.getElementById('logout').addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.href = 'index.html';
});

document.getElementById('toggle-all').addEventListener('click', () => {
  showingAll = !showingAll;
  document.getElementById('toggle-all').innerText = showingAll ? 'Visa f√§rre' : 'Visa alla';
  loadPosts();
});

checkAuth();
</script>
</body>
</html>
