<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyheter</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #003578;
            color: #ffc200;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .post-form, .post, .comment {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        input, textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #ffffff;
            color: #000000;
            border: none;
            border-radius: 3px;
        }
        button {
            background-color: #ffc200;
            color: #003578;
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #e6a800;
        }
        .post-actions, .comment-actions {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nyheter</h1>
        <div id="auth-status"></div>
        
        <!-- Kodkontroll för att visa postformulär -->
        <div id="code-check">
            <input type="text" id="secret-code" placeholder="Ange hemlig kod">
            <button onclick="checkCode()">Verifiera kod</button>
        </div>
        
        <!-- Formulär för att skapa inlägg -->
        <div id="post-form" class="post-form hidden">
            <input type="text" id="post-title" placeholder="Titel">
            <textarea id="post-content" placeholder="Innehåll"></textarea>
            <input type="text" id="post-media" placeholder="Media URL (valfritt)">
            <button onclick="createPost()">Publicera</button>
        </div>

        <!-- Sökfält -->
        <input type="text" id="search-input" placeholder="Sök efter inlägg..." oninput="searchPosts()">
        
        <!-- Inläggslista -->
        <div id="posts-container"></div>
        <button id="toggle-posts" onclick="togglePosts()">Visa alla</button>
    </div>

    <script>
        // Supabase-konfiguration
        const supabaseUrl = 'https://jtbcqgjkvzgcjobfbtad.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YmNxZ2prdnpnY2pvYmZidGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzU0NTksImV4cCI6MjA2OTExMTQ1OX0.ogacm-3bmQI7WDgHZSI2r6jDOrDAGMfI7QtG0avYMTQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        const SECRET_CODE = 'HHGffajkskksm13324..1!?';
        let allPosts = [];
        let displayedPosts = [];
        let showAll = false;

        // Kontrollera inloggning
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            const authStatus = document.getElementById('auth-status');
            if (error || !user) {
                authStatus.innerHTML = 'Du måste vara inloggad. <a href="index.html">Logga in</a>';
                console.error('Fel vid autentisering:', error);
                return false;
            }
            authStatus.innerHTML = `Inloggad som: ${user.email}`;
            return user;
        }

        // Verifiera hemlig kod
        function checkCode() {
            const codeInput = document.getElementById('secret-code').value;
            const postForm = document.getElementById('post-form');
            if (codeInput === SECRET_CODE) {
                postForm.classList.remove('hidden');
                document.getElementById('code-check').classList.add('hidden');
            } else {
                alert('Felaktig kod!');
            }
        }

        // Skapa nytt inlägg
        async function createPost() {
            const user = await checkAuth();
            if (!user) return;

            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const mediaUrl = document.getElementById('post-media').value;

            if (!title || !content) {
                alert('Titel och innehåll krävs!');
                return;
            }

            try {
                const { error } = await supabase
                    .from('posts')
                    .insert([{ title, content, media_url: mediaUrl, user_id: user.id }]);

                if (error) {
                    console.error('Fel vid publicering:', error);
                    alert('Kunde inte publicera inlägget.');
                } else {
                    document.getElementById('post-title').value = '';
                    document.getElementById('post-content').value = '';
                    document.getElementById('post-media').value = '';
                    fetchPosts();
                }
            } catch (err) {
                console.error('Oväntat fel vid publicering:', err);
            }
        }

        // Hämta och visa inlägg
        async function fetchPosts(searchQuery = '') {
            try {
                // Hämta posts och post_likes
                const { data: posts, error: postsError } = await supabase
                    .from('posts')
                    .select(`
                        id, title, content, media_url, user_id, created_at,
                        post_likes!post_likes_post_id_fkey(is_liked)
                    `)
                    .order('created_at', { ascending: false })
                    .ilike('title', `%${searchQuery}%`);

                if (postsError) {
                    console.error('Fel vid hämtning av inlägg:', postsError);
                    return;
                }

                console.log('Hämtade posts:', posts);

                // Hämta comments separat
                const postIds = posts.map(post => post.id);
                const { data: comments, error: commentsError } = await supabase
                    .from('comments')
                    .select(`
                        id, post_id, user_id, text, created_at,
                        comment_likes!comment_likes_comment_id_fkey(is_liked)
                    `)
                    .in('post_id', postIds);

                if (commentsError) {
                    console.error('Fel vid hämtning av kommentarer:', commentsError);
                    // Fortsätt även om kommentarer saknas
                }

                console.log('Hämtade comments:', comments || []);

                // Hämta usernames från Profiles
                const userIds = [
                    ...new Set([
                        ...posts.map(post => post.user_id),
                        ...(comments || []).map(comment => comment.user_id)
                    ])
                ];

                const { data: profiles, error: profilesError } = await supabase
                    .from('Profiles')
                    .select('id, username')
                    .in('id', userIds);

                if (profilesError) {
                    console.error('Fel vid hämtning av profiler:', profilesError);
                    return;
                }

                console.log('Hämtade profiles:', profiles);

                // Skapa username-map
                const usernameMap = profiles.reduce((map, profile) => {
                    map[profile.id] = profile.username;
                    return map;
                }, {});

                // Kombinera data
                allPosts = posts.map(post => ({
                    ...post,
                    username: usernameMap[post.user_id] || 'Okänd användare',
                    comments: (comments || [])
                        .filter(comment => comment.post_id === post.id)
                        .map(comment => ({
                            ...comment,
                            username: usernameMap[comment.user_id] || 'Okänd användare'
                        }))
                }));

                console.log('Kombinerade allPosts:', allPosts);
                updatePostsDisplay();
            } catch (err) {
                console.error('Oväntat fel vid hämtning av inlägg:', err);
            }
        }

        // Uppdatera visning av inlägg
        function updatePostsDisplay() {
            const postsContainer = document.getElementById('posts-container');
            const toggleButton = document.getElementById('toggle-posts');
            displayedPosts = showAll ? allPosts : allPosts.slice(0, 5);
            
            postsContainer.innerHTML = displayedPosts.map(post => {
                const likes = post.post_likes ? post.post_likes.filter(like => like.is_liked).length : 0;
                const dislikes = post.post_likes ? post.post_likes.length - likes : 0;
                const topComments = post.comments
                    ? post.comments
                        .map(comment => ({
                            ...comment,
                            likes: comment.comment_likes ? comment.comment_likes.filter(like => like.is_liked).length : 0,
                            dislikes: comment.comment_likes ? comment.comment_likes.length - comment.comment_likes.filter(like => like.is_liked).length : 0
                        }))
                        .sort((a, b) => b.likes - a.likes)
                        .slice(0, 3)
                    : [];

                return `
                    <div class="post">
                        <h2>${post.title}</h2>
                        <p>${post.content}</p>
                        ${post.media_url ? `<img src="${post.media_url}" alt="Media" style="max-width: 100%;">` : ''}
                        <p>Upplagt av: ${post.username} | ${new Date(post.created_at).toLocaleString()}</p>
                        <div class="post-actions">
                            <button onclick="likePost('${post.id}', true)">Gilla (${likes})</button>
                            <button onclick="likePost('${post.id}', false)">Ogilla (${dislikes})</button>
                        </div>
                        <div class="comments">
                            <h3>Kommentarer</h3>
                            ${topComments.map(comment => `
                                <div class="comment">
                                    <p>${comment.text}</p>
                                    <p>Av: ${comment.username} | ${new Date(comment.created_at).toLocaleString()}</p>
                                    <div class="comment-actions">
                                        <button onclick="likeComment('${comment.id}', true)">Gilla (${comment.likes})</button>
                                        <button onclick="likeComment('${comment.id}', false)">Ogilla (${comment.dislikes})</button>
                                    </div>
                                </div>
                            `).join('')}
                            <button onclick="toggleComments('${post.id}')">${post.comments && post.comments.length > 3 ? 'Visa fler' : ''}</button>
                            <div id="all-comments-${post.id}" class="hidden">
                                ${post.comments ? post.comments.map(comment => `
                                    <div class="comment">
                                        <p>${comment.text}</p>
                                        <p>Av: ${comment.username} | ${new Date(comment.created_at).toLocaleString()}</p>
                                        <div class="comment-actions">
                                            <button onclick="likeComment('${comment.id}', true)">Gilla (${comment.comment_likes ? comment.comment_likes.filter(like => like.is_liked).length : 0})</button>
                                            <button onclick="likeComment('${comment.id}', false)">Ogilla (${comment.comment_likes ? comment.comment_likes.length - comment.comment_likes.filter(like => like.is_liked).length : 0})</button>
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <textarea id="comment-content-${post.id}" placeholder="Skriv en kommentar"></textarea>
                            <button onclick="addComment('${post.id}')">Kommentera</button>
                        </div>
                    </div>
                `;
            }).join('');

            toggleButton.textContent = showAll ? 'Visa färre' : 'Visa alla';
        }

        // Växla mellan visa alla/färre inlägg
        function togglePosts() {
            showAll = !showAll;
            updatePostsDisplay();
        }

        // Växla kommentarer
        function toggleComments(postId) {
            const allCommentsDiv = document.getElementById(`all-comments-${postId}`);
            const toggleButton = allCommentsDiv.previousElementSibling;
            allCommentsDiv.classList.toggle('hidden');
            toggleButton.textContent = allCommentsDiv.classList.contains('hidden') ? 'Visa fler' : 'Visa färre';
        }

        // Gilla/ogilla inlägg
        async function likePost(postId, isLiked) {
            const user = await checkAuth();
            if (!user) return;

            try {
                console.log('Försöker hämta post_likes för post_id:', postId, 'och user_id:', user.id);
                const { data: existingLikes, error: selectError } = await supabase
                    .from('post_likes')
                    .select('*')
                    .eq('post_id', postId)
                    .eq('user_id', user.id);

                if (selectError) {
                    console.error('Fel vid hämtning av post_likes:', selectError);
                    return;
                }

                console.log('Hämtade existingLikes:', existingLikes);

                if (existingLikes && existingLikes.length > 0) {
                    // Uppdatera befintlig like
                    const { error: updateError } = await supabase
                        .from('post_likes')
                        .update({ is_liked: isLiked })
                        .eq('post_id', postId)
                        .eq('user_id', user.id);

                    if (updateError) {
                        console.error('Fel vid uppdatering av post_likes:', updateError);
                        return;
                    }
                } else {
                    // Skapa ny like
                    const { error: insertError } = await supabase
                        .from('post_likes')
                        .insert([{ post_id: postId, user_id: user.id, is_liked: isLiked }]);

                    if (insertError) {
                        console.error('Fel vid insättning av post_likes:', insertError);
                        return;
                    }
                }

                fetchPosts();
            } catch (err) {
                console.error('Oväntat fel vid gilla/ogilla inlägg:', err);
            }
        }

        // Lägg till kommentar
        async function addComment(postId) {
            const user = await checkAuth();
            if (!user) return;

            const content = document.getElementById(`comment-content-${postId}`).value;
            if (!content) {
                alert('Kommentaren kan inte vara tom!');
                return;
            }

            try {
                await supabase
                    .from('comments')
                    .insert([{ post_id: postId, user_id: user.id, text: content }]);

                document.getElementById(`comment-content-${postId}`).value = '';
                fetchPosts();
            } catch (err) {
                console.error('Fel vid kommentering:', err);
            }
        }

        // Gilla/ogilla kommentar
        async function likeComment(commentId, isLiked) {
            const user = await checkAuth();
            if (!user) return;

            try {
                console.log('Försöker hämta comment_likes för comment_id:', commentId, 'och user_id:', user.id);
                const { data: existingLikes, error: selectError } = await supabase
                    .from('comment_likes')
                    .select('*')
                    .eq('comment_id', commentId)
                    .eq('user_id', user.id);

                if (selectError) {
                    console.error('Fel vid hämtning av comment_likes:', selectError);
                    return;
                }

                console.log('Hämtade existingLikes:', existingLikes);

                if (existingLikes && existingLikes.length > 0) {
                    const { error: updateError } = await supabase
                        .from('comment_likes')
                        .update({ is_liked: isLiked })
                        .eq('comment_id', commentId)
                        .eq('user_id', user.id);

                    if (updateError) {
                        console.error('Fel vid uppdatering av comment_likes:', updateError);
                        return;
                    }
                } else {
                    const { error: insertError } = await supabase
                        .from('comment_likes')
                        .insert([{ comment_id: commentId, user_id: user.id, is_liked: isLiked }]);

                    if (insertError) {
                        console.error('Fel vid insättning av comment_likes:', insertError);
                        return;
                    }
                }

                fetchPosts();
            } catch (err) {
                console.error('Fel vid gilla/ogilla kommentar:', err);
            }
        }

        // Sök inlägg
        function searchPosts() {
            const searchQuery = document.getElementById('search-input').value;
            fetchPosts(searchQuery);
        }

        // Initial laddning
        checkAuth().then(user => {
            if (user) fetchPosts();
        });
    </script>
</body>
</html>
