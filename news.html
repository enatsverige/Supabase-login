<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyheter</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #003578;
            color: #ffc200;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .post-form, .post, .comment {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        input, textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #ffffff;
            color: #000000;
            border: none;
            border-radius: 3px;
        }
        button {
            background-color: #ffc200;
            color: #003578;
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #e6a800;
        }
        .post-actions, .comment-actions {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nyheter</h1>
        <div id="auth-status"></div>
        
        <!-- Kodkontroll för att visa postformulär -->
        <div id="code-check">
            <input type="text" id="secret-code" placeholder="Ange hemlig kod">
            <button onclick="checkCode()">Verifiera kod</button>
        </div>
        
        <!-- Formulär för att skapa inlägg -->
        <div id="post-form" class="post-form hidden">
            <input type="text" id="post-title" placeholder="Titel">
            <textarea id="post-content" placeholder="Innehåll"></textarea>
            <input type="text" id="post-media" placeholder="Media URL (valfritt)">
            <button onclick="createPost()">Publicera</button>
        </div>

        <!-- Sökfält -->
        <input type="text" id="search-input" placeholder="Sök efter inlägg..." oninput="searchPosts()">
        
        <!-- Inläggslista -->
        <div id="posts-container"></div>
        <button id="toggle-posts" onclick="togglePosts()">Visa alla</button>
    </div>

    <script>
        // Supabase-konfiguration
        const supabaseUrl = 'https://jtbcqgjkvzgcjobfbtad.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YmNxZ2prdnpnY2pvYmZidGFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MzU0NTksImV4cCI6MjA2OTExMTQ1OX0.ogacm-3bmQI7WDgHZSI2r6jDOrDAGMfI7QtG0avYMTQ';
        const supabase = Supabase.createClient(supabaseUrl, supabaseKey);
        
        const SECRET_CODE = 'HHGffajkskksm13324..1!?';
        let allPosts = [];
        let displayedPosts = [];
        let showAll = false;

        // Kontrollera inloggning
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            const authStatus = document.getElementById('auth-status');
            if (!user) {
                authStatus.innerHTML = 'Du måste vara inloggad. <a href="index.html">Logga in</a>';
                return false;
            }
            authStatus.innerHTML = `Inloggad som: ${user.email}`;
            return user;
        }

        // Verifiera hemlig kod
        function checkCode() {
            const codeInput = document.getElementById('secret-code').value;
            const postForm = document.getElementById('post-form');
            if (codeInput === SECRET_CODE) {
                postForm.classList.remove('hidden');
                document.getElementById('code-check').classList.add('hidden');
            } else {
                alert('Felaktig kod!');
            }
        }

        // Skapa nytt inlägg
        async function createPost() {
            const user = await checkAuth();
            if (!user) return;

            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const mediaUrl = document.getElementById('post-media').value;

            if (!title || !content) {
                alert('Titel och innehåll krävs!');
                return;
            }

            const { error } = await supabase
                .from('posts')
                .insert([{ title, content, media_url: mediaUrl, user_id: user.id }]);

            if (error) {
                console.error('Fel vid publicering:', error);
                alert('Kunde inte publicera inlägget.');
            } else {
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('post-media').value = '';
                fetchPosts();
            }
        }

        // Hämta och visa inlägg
        async function fetchPosts(searchQuery = '') {
            const { data: posts, error } = await supabase
                .from('posts')
                .select(`
                    *,
                    Profiles!posts_user_id_fkey(username),
                    post_likes!post_likes_post_id_fkey(is_liked),
                    comments!comments_post_id_fkey(
                        *,
                        Profiles!comments_user_id_fkey(username),
                        comment_likes!comment_likes_comment_id_fkey(is_liked)
                    )
                `)
                .order('created_at', { ascending: false })
                .ilike('title', `%${searchQuery}%`);

            if (error) {
                console.error('Fel vid hämtning av inlägg:', error);
                return;
            }

            allPosts = posts;
            updatePostsDisplay();
        }

        // Uppdatera visning av inlägg
        function updatePostsDisplay() {
            const postsContainer = document.getElementById('posts-container');
            const toggleButton = document.getElementById('toggle-posts');
            displayedPosts = showAll ? allPosts : allPosts.slice(0, 5);
            
            postsContainer.innerHTML = displayedPosts.map(post => {
                const likes = post.post_likes.filter(like => like.is_liked).length;
                const dislikes = post.post_likes.length - likes;
                const topComments = post.comments
                    .map(comment => ({
                        ...comment,
                        likes: comment.comment_likes.filter(like => like.is_liked).length,
                        dislikes: comment.comment_likes.length - comment.comment_likes.filter(like => like.is_liked).length
                    }))
                    .sort((a, b) => b.likes - a.likes)
                    .slice(0, 3);

                return `
                    <div class="post">
                        <h2>${post.title}</h2>
                        <p>${post.content}</p>
                        ${post.media_url ? `<img src="${post.media_url}" alt="Media" style="max-width: 100%;">` : ''}
                        <p>Upplagt av: ${post.Profiles.username} | ${new Date(post.created_at).toLocaleString()}</p>
                        <div class="post-actions">
                            <button onclick="likePost('${post.id}', true)">Gilla (${likes})</button>
                            <button onclick="likePost('${post.id}', false)">Ogilla (${dislikes})</button>
                        </div>
                        <div class="comments">
                            <h3>Kommentarer</h3>
                            ${topComments.map(comment => `
                                <div class="comment">
                                    <p>${comment.content}</p>
                                    <p>Av: ${comment.Profiles.username} | ${new Date(comment.created_at).toLocaleString()}</p>
                                    <div class="comment-actions">
                                        <button onclick="likeComment('${comment.id}', true)">Gilla (${comment.likes})</button>
                                        <button onclick="likeComment('${comment.id}', false)">Ogilla (${comment.dislikes})</button>
                                    </div>
                                </div>
                            `).join('')}
                            <button onclick="toggleComments('${post.id}')">${post.comments.length > 3 ? 'Visa fler' : ''}</button>
                            <div id="all-comments-${post.id}" class="hidden">
                                ${post.comments.map(comment => `
                                    <div class="comment">
                                        <p>${comment.content}</p>
                                        <p>Av: ${comment.Profiles.username} | ${new Date(comment.created_at).toLocaleString()}</p>
                                        <div class="comment-actions">
                                            <button onclick="likeComment('${comment.id}', true)">Gilla (${comment.comment_likes.filter(like => like.is_liked).length})</button>
                                            <button onclick="likeComment('${comment.id}', false)">Ogilla (${comment.comment_likes.length - comment.comment_likes.filter(like => like.is_liked).length})</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <textarea id="comment-content-${post.id}" placeholder="Skriv en kommentar"></textarea>
                            <button onclick="addComment('${post.id}')">Kommentera</button>
                        </div>
                    </div>
                `;
            }).join('');

            toggleButton.textContent = showAll ? 'Visa färre' : 'Visa alla';
        }

        // Växla mellan visa alla/färre inlägg
        function togglePosts() {
            showAll = !showAll;
            updatePostsDisplay();
        }

        // Växla kommentarer
        function toggleComments(postId) {
            const allCommentsDiv = document.getElementById(`all-comments-${postId}`);
            const toggleButton = allCommentsDiv.previousElementSibling;
            allCommentsDiv.classList.toggle('hidden');
            toggleButton.textContent = allCommentsDiv.classList.contains('hidden') ? 'Visa fler' : 'Visa färre';
        }

        // Gilla/ogilla inlägg
        async function likePost(postId, isLiked) {
            const user = await checkAuth();
            if (!user) return;

            const { data: existingLike } = await supabase
                .from('post_likes')
                .select('*')
                .eq('post_id', postId)
                .eq('user_id', user.id)
                .single();

            if (existingLike) {
                await supabase
                    .from('post_likes')
                    .update({ is_liked: isLiked })
                    .eq('post_id', postId)
                    .eq('user_id', user.id);
            } else {
                await supabase
                    .from('post_likes')
                    .insert([{ post_id: postId, user_id: user.id, is_liked: isLiked }]);
            }

            fetchPosts();
        }

        // Lägg till kommentar
        async function addComment(postId) {
            const user = await checkAuth();
            if (!user) return;

            const content = document.getElementById(`comment-content-${postId}`).value;
            if (!content) {
                alert('Kommentaren kan inte vara tom!');
                return;
            }

            await supabase
                .from('comments')
                .insert([{ post_id: postId, user_id: user.id, content }]);

            document.getElementById(`comment-content-${postId}`).value = '';
            fetchPosts();
        }

        // Gilla/ogilla kommentar
        async function likeComment(commentId, isLiked) {
            const user = await checkAuth();
            if (!user) return;

            const { data: existingLike } = await supabase
                .from('comment_likes')
                .select('*')
                .eq('comment_id', commentId)
                .eq('user_id', user.id)
                .single();

            if (existingLike) {
                await supabase
                    .from('comment_likes')
                    .update({ is_liked: isLiked })
                    .eq('comment_id', commentId)
                    .eq('user_id', user.id);
            } else {
                await supabase
                    .from('comment_likes')
                    .insert([{ comment_id: commentId, user_id: user.id, is_liked: isLiked }]);
            }

            fetchPosts();
        }

        // Sök inlägg
        function searchPosts() {
            const searchQuery = document.getElementById('search-input').value;
            fetchPosts(searchQuery);
        }

        // Initial laddning
        checkAuth().then(user => {
            if (user) fetchPosts();
        });
    </script>
</body>
</html>
